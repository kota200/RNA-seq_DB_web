<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>🌾Millet RNA-seq database（建設中）🌾</title>
<link href="db.css" type="text/css" rel="stylesheet" />

<!--Plugin CSS files-->
<link rel="stylesheet" href="js/ion-rangeslider-2.3.0/ion.rangeSlider.min.css"/>
<script src="js/jquery-3.4.1/jquery.min.js"></script>
<script src="js/ion-rangeslider-2.3.0/ion.rangeSlider.min.js"></script>
<script src="js/plot.ly/plotly-1.32.0.min.js"></script>
<script src="js/plot.ly/plotly-latest.min.js"></script>
<script src="js/cytoscape/cytoscape.min.js"></script>
<!--script src="js/cytoscape/cose.js"></script-->
<script src="js/unpkg.com/canvas-datagrid"></script>
<script src="js/igv-2.2.14/igv.min.js"></script>
<script src="js/verTree/verTree.js"></script>

<script src="js/jquery-ui-1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="js/jquery-ui-1.13.2/jquery-ui.min.css">
<link rel="stylesheet" href="js/jquery-ui-1.13.2/jquery-ui.theme.min.css">
<link rel="stylesheet" href="js/jquery-ui-1.13.2/jquery-ui.structure.min.css">

<style>
.ui-autocomplete {max-height: 200px;overflow-y:auto;overflow-x: hidden;padding-right: 20px;} 
</style>


</head>
<body>
<div id="title">
            <h1>
                <span>🌾RNA-seq database for millet（建設中）🌾</span>
		<br>
            </h1>
</div>
<div class="theadertop">
        <a href="https://park.itc.u-tokyo.ac.jp/lgpr/index.html"><div class="logo"><img src="image/LGPR.png"></div></a>
	<div class="verline">
	<br>
	</div>
</div>
<!-- 横サイドバー用スタイル -->
<style>
.sidebar-links {
    position: fixed;
    top: 200px;
    left: 20px;
    width: 200px;
    background-color: #ffffff;
    padding: 5px;
    border: 1px solid #ccc;
    font-size: 1em;
    color: #708090;
    z-index: 9999;
}

.sidebar-links a {
    display: block;
    color: #708090;
    text-decoration: none;
    padding: 5px 0;
    border-bottom: 1px solid #ccc; /* 横線 */
    text-align: center;
    font-weight: bold;
}

.sidebar-links a:last-child {
    border-bottom: none;
}
</style>
<!-- サイドバーのHTML -->
<div class="sidebar-links">
    <a href="foxtail milletとか？">Foxtail millet</a>
    <a href="finger milletとか？">Finger millet</a>
    <a href="ソルガムとか？">Sorghum</a>
    <a href="chickpeaとか？">Chick pea</a>
    <a href="ヒエとか？">Barnyard millet</a>
</div>

<script>
function setCookie(name,value,d){
var exp = new Date();
exp.setTime(exp.getTime() + d*24*60*60*1000);
document.cookie = name + "="+ escape (value) + ";expires=" + exp.toGMTString();
};

function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
         }
         if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
         }
     }
    return "";
};


setCookie("newtable", "no", 1);
setCookie("newigv", "no", 1);
setCookie("newplot", "no", 1);
setCookie("newinfo", "no", 1);
//setCookie("trans", "yes", 1);


$.fn.scrollUnique = function() {
    return $(this).each(function() {
        var eventType = 'mousewheel';
        if (document.mozHidden !== undefined) {
            eventType = 'DOMMouseScroll';
        }
        $(this).on(eventType, function(event) {
            var scrollTop = this.scrollTop,
                scrollHeight = this.scrollHeight,
                height = this.clientHeight;

            var delta = (event.originalEvent.wheelDelta) ? event.originalEvent.wheelDelta : -(event.originalEvent.detail || 0);        

            if ((delta > 0 && scrollTop <= delta) || (delta < 0 && scrollHeight - height - scrollTop <= -1 * delta)) {
                this.scrollTop = delta > 0? 0: scrollHeight;
                event.preventDefault();
            }        
        });
    });	
};


</script>

<div class="theaderup">
</div>
<div class="headtitle">
		Pearl millet RNA-seq Database 
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<div class="input1bg">
	<form role="search">
		<div class="input1">
			<div class="input11" id="dataInput">
				<input type="text" id="search" placeholder="Search Gene">
			</div>
			<div class="input12" id="input12">
				<button class="button" id="submit" type="button" onclick="search1();">
					<i class="fas fa-search" style="font-size: 32px; color: #333;"></i>
				</button>
			</div>
		</div>
	</form>
</div>

<div class="headinfo">
	<div class="doc">
		<a href="The download link for the TPM file" target="_blank">Raw data download</a>
	</div>		
</div>

<div class="inputbg">
 <!--   <div class="advancetag">Tissue:</div> -->
	<div class="advancediv2">
		<div id="tree_list_tissue" ></div>
		<div id="tree_list_treatment" ></div>
	</div>
    <div class="advancetag">Genotype:</div>
    <div class="advancediv">
        <input class="advancefilter" type="text" id="ffgenotype" placeholder="genotype">
    </div>

	<div class="input31" >FPKM:</div>
	<div class="input32" style='color:white'>
		<input type="text" class="js-range-slider" id="fpkm" name="fpkm" value="" /> <!--class="js-range-slider"-->
	</div>
	<div class="input41">
		<button class="button" id="submit" type="button" onclick="search1();$('#ffgenotype').val('');">Submit</button>
	</div>
</div>

<div class="outputlabelsbg">
	<div class="outputlabels">
		<ul class="labelbg" >
			<li>
			Information
			</li>
			<li>
			Data Table
			</li>
			<li class="label">
			Data Plot
			</li>
			<li class="label">
			CoExpression
			</li>
			<li class="label active">
			IGV Online
			</li>
		</ul>

		<div id="sizectrl" onclick="changesize()">
		</div>
		<div id="shareres" onclick="shareit()">
		</div>
	</div>

</div>

<div class="result resinfo" id="resinfo"></div>

<div class="restablebg">
	<div class="result">
		<div class="tname" >  <!--added by Hong-->
			Filter:
		</div>
		<div class="filterctr">
			<!--input class="autofilter" id="ffpkm" type="number" placeholder="FPKM Value"--> 
			<input class="autofilter" id="fecotype" type="text" placeholder="Cultivar">
			<input class="autofilter" id="fgenotype" type="text" placeholder="Genotype ">
			<input class="autofilter" id="ftissue" type="text" placeholder="Tissue Name">
			<input class="autofilter" id="fproject" type="text" placeholder="Project ID">
			<input class="autofilter" id="ftreatment" type="text" placeholder="Treatment">
		</div>
		<button class="tablesubmit1" onclick="loadtb2();$('#fecotype').val('');$('#fgenotype').val('');$('#ftissue').val('');$('#fproject').val('');$('#ftreatment').val('');">Submit</button>
		<div class="resdownload" id="tbdl">
			Download
		</div>
		<div class="tabpage" id="tabpageend"><img src="image/end.png"></div>
		<div class="tabpage" id="tabpagedown"><img src="image/down.png"></div>
		<div class="tabpage" id="tabpageup"><img src="image/up.png"></div>
		<div class="tabpage" id="tabpagetop"><img src="image/top.png"></div>
	</div>
	<div class="result" class="restable" id="tablebg">
	</div>
</div>

<div class="resplotbg">
	<div class="resplottissue left" id="tissueall"></div>
	<div class="resplottissue center" id="tissuebox"></div>
	<div class="resplottissue toigv" id="tissuetoigv"></div>
	<div class="resplotstress left" id="abiotic"></div>
	<div class="resplotstress center" id="biotic"></div>
	<div class="resplotmutant left" id="barplot1"></div>
	<div class="resplotmutant center" id="barplot2"></div>
	<div class="resplotmutant toigv" id="mutanttoigv"></div>
	<div class="resplottreat left" id="treatment1"></div>
	<div class="resplottreat center" id="treatment2"></div>
	<div class="resplottreat toigv" id="treattoigv"></div>
	<div class="resplotother center" id="geneviolin"></div>
	<div class="resplotother center" id="lineplot"></div>
</div>
<div class="rescoexbg">
	<!--div class="rescoexnet" id="resconet"></div-->
	<div class="rescoextable" id="rescotabletitle" style="text-algin:right;font-size:18px;height:50px;"></div>
	<div class="rescoextable" id="rescotable"></div>
</div>

<div class="outputigv">
	<div class="igvctrlbg">
		<div class="igvctrl">
			<div class="igvct1">
				Load Library and Locus:
			</div>
			<div class="igvct2">
				<input class="autocomp1" id="igvlibid" type="text" placeholder="LibraryID" >
				<input class="autocomp2" id="igvgeneid" type="text" placeholder="geneID" >
				<input class="autocomp1" id="studyid" type="text" placeholder="&nbsp;Project" >
				<input class="autocomp1" id="tissueid" type="text" placeholder="&nbsp;tissueProject" >
				<input class="autocomp1" id="mutantid" type="text" placeholder="&nbsp;mutantProject" >
				<input class="autocomp1" id="treatid" type="text" placeholder="&nbsp;treatmentProject" >
			</div>
			<button class="acsubmit1" onclick="addalignmentandzoomin();$('#igvlibid').val('');$('#igvgeneid').val('');$('#studyid').val('');$('#tissueid').val('');$('mutantid').val('');$('#treatid').val('');">submit</button>
			<button class="acsubmit3" onclick="reloadigv()">clear tracks</button>

		</div>
	</div>
	<div  class="showigv" id="showigv">
	</div>
</div>

<div class="theaderbottom">
</div>

</body>
<script>
$('#tablebg').scrollUnique();

var treatdata = [
	{"id":"110000","name":"Biotic Stress","parentId":"100000","children":[
//		{"id":"110100","name":"Viridiplantae plant exposure","parentId":"110000","children":[]},	
//		{"id":"110200","name":"Stramenopiles exposure","parentId":"110000","children":[]},
		{"id":"110300","name":"Virus plant exposure","parentId":"110000","children":[]},
//		{"id":"110400","name":"Mycoplasma exposure","parentId":"110000","children":[]},
		{"id":"110500","name":"Fungal plant exposure","parentId":"110000","children":[]},
		{"id":"110600","name":"Bacterial plant exposure","parentId":"110000","children":[]},
		{"id":"110700","name":"Metazoan plant exposure","parentId":"110000","children":[]}
	]},
	{"id":"120000","name":"Abiotic Stress","parentId":"100000","children":[
//		{"id":"120100","name":"Ecological environment","parentId":"120000","children":[]},
		{"id":"120200","name":"Chemical exposure","parentId":"120000","children":[]},
		{"id":"120300","name":"Physical plant exposure","parentId":"120000","children":[]}
	]}
	];
new verTree({
    items:"#tree_list_treatment",
    type:"form",//list:表格展示 data:一般展示 form：表单展示
    data:treatdata,
    parent:"parentId",
    params:"id",
    value:"name",
    name: "tree_treatment",
//    defaults:["110000"],
	open_close:"open"
    });
	
var tissuedata = [
	{"id":"210000","name":"All Tissue","parentId":"200000","children":[
		{"id":"210100","name":"Root","parentId":"210000","children":[]},	
		{"id":"210200","name":"Leaf","parentId":"210000","children":[]},
		{"id":"210300","name":"Seedling","parentId":"210000","children":[]},
		{"id":"210400","name":"Shoot","parentId":"210000","children":[]},
		{"id":"210500","name":"Stem","parentId":"210000","children":[]},
		{"id":"210600","name":"Meristem","parentId":"210000","children":[]},
		{"id":"210700","name":"Flower","parentId":"210000","children":[]},
		{"id":"210800","name":"Panicle","parentId":"210000","children":[]},
		{"id":"210900","name":"Female reproductive tissue","parentId":"210000","children":[]},
		{"id":"210130","name":"Male reproductive tissue","parentId":"210000","children":[]},
		{"id":"210100","name":"Seed","parentId":"210000","children":[]},
		{"id":"210110","name":"Embryo","parentId":"210000","children":[]},
		{"id":"210120","name":"Endosperm","parentId":"210000","children":[]},
	]}
	];
new verTree({
    items:"#tree_list_tissue",
    type:"form",//list:表格展示 data:一般展示 form：表单展示
    data:tissuedata,
    parent:"parentId",
    params:"id",
    value:"name",
    name: "tree_tissue",
//    defaults:["110000"],
	open_close:"open"
    });

$(document).ready(function(){
        $('#search').bind('keypress',function(event){
                if(event.keyCode == "13"){
                        if ($('#search').val() != ""){
                                search1();
				return false;
                        };
                };
        });
});



function reloadigv(){
	$("#showigv").html("");
	$("#showigv").remove();
	var newigv = '<div class="showigv" id="showigv"></div>';
	$(".outputigv").append(newigv);
	delete igv.browser;
	loadigv();
};
function showcheckboxes() {
  var checkboxes = document.getElementById("checkboxes");
  var expanded = false;
  if (!expanded) {
    checkboxes.style.display = "block";
    expanded = true;
  } else {
    checkboxes.style.display = "none";
    expanded = false;
  }
}
function shareit(){
	var encode = getCookie("info");
	encode = encode.replace("user/","");
	encode = encode.replace(".info","");
//	alert("https://plantrnadb.com//athrna/?share="+encode);
	var Url2="https://plantrnadb.com//ricerna/?share="+encode;
	var oInput = document.createElement('input');
	oInput.value = Url2;
	document.body.appendChild(oInput);
	oInput.select(); 
	document.execCommand("Copy"); 
	oInput.className = 'oInput';
	oInput.style.display='none';
	alert("URL copied!\n" + Url2);
};

function alllib(){
	$(".outputlabelsbg").show();
	$(".labelbg li").eq(0).removeClass("active");
	$(".labelbg li").eq(1).addClass("active");
	$(".labelbg li").eq(2).removeClass("active");
	$(".labelbg li").eq(3).removeClass("active");
	$(".labelbg li").eq(4).removeClass("active");
	$(".resinfo").hide();
	$(".resplotbg").hide();
	$(".rescoexbg").hide();
	$(".outputigv").hide();
	$(".restablebg").show();

	$(".resinfo").html("");
	$("#tissueall").html("");
	$("#tissuebox").html(""); /*added by Hong*/
	$("#abiotic").html("");
	$("#biotic").html("");
	$("#barplot1").html(""); /*added by Hong*/
	$("#barplot2").html("")
	$("#treatment1").html(""); /*added by Hong*/
	$("#treatment2").html("");
	$("#geneviolin").html("");
	$("#lineplot").html("");
	$("#resconet").html(""); /*added by Hong*/
	$("#rescotable").html(""); /*added*/
	$("#rescotabletitle").html("");
	$("#tbanno").hide();
	$("#tbdl").show();
	$("#tbdl").html("download table with more information");
	$("#tablebg").html("");
	$("#tablebg").show();
        var ecotype = $('#fecotype').val();
        var genotype = $('#fgenotype').val();
        var tissue = $('#ftissue').val();
        var project = $('#fproject').val();
	var treatment = $('#ftreatment').val();
        $('#tablebg').html('');

	setCookie("table", "data/lib_base_info_for_alllib.xls", 1);
	loadtb('data/libraryInfor',ecotype, genotype, tissue, project);
};

$(document).ready(function(){
	$(".underinputclick").click(function(){
		if ($(".underinput3").text()=="-"){
			$(".underinput3").text("+")
		}else{
			$(".underinput3").text("-")
		};
		$(".inputbg").slideToggle(400);
	});
});	


function search1(){  //changed by Hong
    var advanced_tissue = "";
	$("#tree_list_tissue input[type=checkbox]").each(function() {
		if($(this).is(":checked")) {
			advanced_tissue += $(this).attr('value')+",";
		}
	});
	advanced_tissue = advanced_tissue.slice(0,-1);
//	alert(advanced_tissue);
	var advanced_treatment = "";
	$("#tree_list_treatment input[type=checkbox]").each(function() {
		if($(this).is(":checked")) {
			advanced_treatment += $(this).attr('value')+",";
		}
	});
	advanced_treatment = advanced_treatment.slice(0,-1);
//	alert(advanced_treatment);
	var inputs = $("#search").val().toUpperCase().replace(/ /g,",");

	var fpkms = $("#fpkm").val().replace(";","/");
	if (fpkms == "null/null"){ 
		fpkms = "0/max";		
	};
//	var treat=''; //something
//	var tissue = $('#fftissue').val();
	var geno = $('#ffgenotype').val();
	var content = inputs + "/"+ fpkms+"/"+advanced_treatment+"/"+advanced_tissue+"/"+geno+"/"; //search command: genes,libs/fpkmmin/fpkmmax/treatment/tissue/genotype/ecotype
	content = content.replace(/ /g,"NAN");
	addhistory(content);
	$(".outputlabelsbg").show();
	$(".labelbg li").eq(0).click();
	$("#resinfo").html('<div style="width:100%;text-align:center"><img src="image/info.gif"/></div>');
	$("#resinfo").load("Search.php?query="+content);
};

function search_example(inputs){
    var advanced_tissue = "";
	$("#tree_list_tissue input[type=checkbox]").each(function() {
		if($(this).is(":checked")) {
			advanced_tissue += $(this).attr('value')+",";
		}
	});
	advanced_tissue = advanced_tissue.slice(0,-1);
//	alert(advanced_tissue);
	var advanced_treatment = "";
	$("#tree_list_treatment input[type=checkbox]").each(function() {
		if($(this).is(":checked")) {
			advanced_treatment += $(this).attr('value')+",";
		}
	});
	advanced_treatment = advanced_treatment.slice(0,-1);
//	alert(advanced_treatment);
//	var inputs = $("#search").val().toUpperCase().replace(/ /g,",");

	var fpkms = $("#fpkm").val().replace(";","/");
	if (fpkms == "null/null"){ 
		fpkms = "0/max";		
	};
//	var treat=''; //something
//	var tissue = $('#fftissue').val();
	var geno = $('#ffgenotype').val();
	var content = inputs + "/"+ fpkms+"/"+advanced_treatment+"/"+advanced_tissue+"/"+geno+"/"; //search command: genes,libs/fpkmmin/fpkmmax/treatment/tissue/genotype/ecotype
	content = content.replace(/ /g,"NAN");
	addhistory(content);
	$(".outputlabelsbg").show();
	$(".labelbg li").eq(0).click();
	$("#resinfo").html('<div style="width:100%;text-align:center"><img src="image/info.gif"/></div>');

	$("#resinfo").load("Search.php?query="+content);
};

function search2(content){
	var content_arr = content.split("/"); //genes,libs/fkmmin/fpkmmax
	updaterange(content_arr[1],content_arr[2]);
	var advanced_tissue = "";
	$("#tree_list_tissue input[type=checkbox]").each(function() {
		if($(this).is(":checked")) {
                        advanced_tissue += $(this).attr('value')+",";
                }
        });
        advanced_tissue = advanced_tissue.slice(0,-1);
//      alert(advanced_tissue);
        var advanced_treatment = "";
        $("#tree_list_treatment input[type=checkbox]").each(function() {
                if($(this).is(":checked")) {
                        advanced_treatment += $(this).attr('value')+",";
                }
        });
        advanced_treatment = advanced_treatment.slice(0,-1);
	var geno = $('#ffgenotype').val();
	content += advanced_treatment+"/"+advanced_tissue+"/"+geno;
	addhistory(content);
	$(".outputlabelsbg").show();
	$(".labelbg li").eq(0).click();
	$("#resinfo").html('<div style="width:100%;text-align:center"><img src="image/info.gif"/></div>');
	$("#resinfo").load("Search.php?query="+content);
};

function showside(){
	var a = document.getElementById("historyside");
	var disp = a.style.display;
	if (disp == "block"){
		a.style="display: none";
	}else{
		a.style="display: block";
	}
	
};

function gotoigv1(){ //tissue to igv
	var a = document.getElementById("tissuetoigv");
	var disp = a.style.display;
	if(disp == "block"){
		a.style="display: none";
	}else{
		a.style="display: block";
	}
}
function gotoigv2(){
	var a = document.getElementById("mutanttoigv");
	var disp = a.style.display;
	if(disp == "block"){
		a.style="display: none";
	}else{
		a.style="display: block";
	}
}
function gotoigv3(){
	var a = document.getElementById("treattoigv");
	var disp = a.style.display;
	if(disp == "block"){
		a.style="display: none";
	}else{
		a.style="display: block";
	}
}

function post(content){
	var words = content.split(';');
	var geneid = words[0];
	var libid = words[1];
	var fpkm = words[2]+';'+words[3];
 
	var postForm = document.createElement("form");//表单对象
	postForm.method="post" ;
	postForm.action = '#tablebg' ;
 
	var geneidInput = document.createElement("input") ; 
	geneidInput.setAttribute("name", "geneid") ;
	geneidInput.setAttribute("value", geneid);
	postForm.appendChild(geneidInput) ;
	var libidInput = document.createElement("input");
	libidInput.setAttribute("name","libid");
	libidInput.setAttribute("value",libid);
	postForm.appendChild(libidInput);
	var fpkmInput = document.createElement("input");
	fpkmInput.setAttribute("name","fpkm");
	fpkmInput.setAttribute("value",fpkm);
	postForm.appendChild(fpkmInput);
 
	document.body.appendChild(postForm) ;
	postForm.submit() ;
	document.body.removeChild(postForm) ;
};


$(".js-range-slider").ionRangeSlider({
	type: "double",
	values: ["0","0.5","1","2","3","4","5","6","7","8","9","10","20","30","40","50","60","70","80","90","100","200","300","400","500","1000","max"],
	grid: true
});

let my_range = $(".js-range-slider").data("ionRangeSlider");

function updaterange(fpkm1,fpkm2){
	var values = new Array("0","0.5","1","2","3","4","5","6","7","8","9","10","20","30","40","50","60","70","80","90","100","200","300","400","500","1000","max");
for (var i = 0; i < values.length; i++){
	if (values[i]==fpkm1){var f1 = i};
	if (values[i]==fpkm2){var f2 = i; break};
};
my_range.update({
	from: f1,
	to: f2
});
};


function changesize(){
var bgimg = $("#sizectrl").css("background-image");
if (bgimg.search("smallsize") == -1){
	$("#sizectrl").css("background-image","url(image/smallsize.png)");
	$(".theadertop").slideToggle(400);
	$(".headdiv").slideToggle(400);
	$(".headinfo").slideToggle(400);
	$(".input1bg").slideToggle(400);
}else{
	$("#sizectrl").css("background-image","url(image/fullsize.png)");
	$(".theadertop").slideToggle(400);
	$(".headdiv").slideToggle(400);
	$(".headinfo").slideToggle(400);
	$(".input1bg").slideToggle(400);
}
};

$(document).ready(function(){
$(".labelbg li").click(function(){
	$(".labelbg li").eq(0).removeClass("active");	
	$(".labelbg li").eq(1).removeClass("active");
	$(".labelbg li").eq(2).removeClass("active");
	$(".labelbg li").eq(3).removeClass("active");
	$(".labelbg li").eq(4).removeClass("active");
	$(this).addClass("active");
	var idx = $(".labelbg li").index(this);
	$("#resinfo").css('display', 'none');
	$(".restablebg").css('display', 'none');
	$(".resplotbg").css('display', 'none');
	$(".rescoexbg").css('display', 'none');
	$(".outputigv").css('display', 'none');
	var newtb = getCookie("newtable");
	var newigv = getCookie("newigv");
	var newplot = getCookie("newplot");
	var newinfo = getCookie("newinfo");
	var stype = getCookie("stype");
	var newco = getCookie("newco"); /*added*/
	if (idx==0){
		$("#resinfo").show();
		if (newinfo=="yes"){
			setCookie("newinfo", "no", 1);
		};
	};
	if (idx==2){
		$(".resplotbg").show();
		if (newplot=="yes"){
				$("#geneviolin").remove();
				$("#tissueall").html("");
				//$("#treatside").after('<div class="resplotother" class="center" id="geneviolin"></div>');
				//$("#tissueall").html("");//before('<div class="result" class="resplot" id="geneviolin"> </div>')
				$("#tissuebox").html("");
				$("#abiotic").html("");
			        $("#biotic").html("");

				$("#barplot1").html("");//added by Hong
				$("#barplot2").html("");
				$("#treatment1").html(""); //added by Hong
                                $("#treatment2").html("");
				$("#tissuetoigv").html("");
			        $("#mutanttoigv").html("");
			        $("#treattoigv").html("");
			        $("#tissueside").html("");
        			$("#mutantside").html("");
			        $("#treatside").html("");
				$("#lineplot").before('<div class="resplotother" class="center" id="geneviolin"> </div>'); //added by Hong
				//$("#geneviolin").html("");
				$("#lineplot").html("");
				plotline2();
				plotbox2();
				plotstress2();
				geneviolinplot();
				libraryviolinplot();
				setCookie("newplot", "no", 1);
			};
		};
		if (idx==1){
			$(".restablebg").show();
			if (stype == "yes"){ //added by Hong
				//alert("Test");
				$("#tablebg").html("");
				$("#transbg").remove();
				$("#tbdl").after('<div class="resdownload" id="transbg" onclick=transpose()>Transpose</div>');
			}else if(stype == "no" && newtb=="yes"){
				$("#transbg").remove();
			};
			if (newtb=="yes"){
				$("#tablebg").html("");
                        	$("#tbdl").show();
                        	loadtb2();
				setCookie("newtable", "no", 1);
			};
			setCookie("stype", "no", 1);
		};
		if (idx==3){ /*added*/
			$(".rescoexbg").show();
			if(newco == "yes"){
				//$("#resconet").html("");
				$("#rescotabletitle").html("");
				$("#rescotable").html("");
				var ntfile = getCookie("networkcsv");
				setCookie("newco", "no", 1);
				loadconet2(ntfile);
				//alert(ntfile);
				//plotcoex();
				//loadcotable();	
				/*do something*/
			}
		}
		if (idx==4){
			$(".outputigv").show()
		};

	});
});

//var tabpage = 0;
function loadtb(tb, ecotype, genotype, tissue, project,treatment){
	var xhr = new XMLHttpRequest(),
	    grid = canvasDatagrid({
        	parentNode: document.getElementById("tablebg"),
    	});
	grid.style.height = '700px';
	grid.style.width = '100%';
	grid.style.columnHeaderCellFont = "18px sans-serif";
	grid.style.columnHeaderCellHorizontalAlignment = "center";
	grid.style.columnHeaderCellHeight = 40;
	grid.style.cellHorizontalAlignment = "center";
	grid.style.scrollBarBoxWidth = 15;
	grid.style.scrollBarWidth = 15;
	grid.style.scrollBarBoxColor = "#4169E1";
	grid.style.scrollBarActiveColor = "#4169E1";
	function parseOpenData(openData) {
    		var data, schema = openData.meta.view.columns;
    		data = openData.data.map(function (row) {
        		var r = {};
        		schema.forEach(function (column, index) {
            			r[column.name] = row[index];
        		});
        		return r;
    		});
    		return {
        		data: data,
        		schema: schema
    		};
	}
	xhr.addEventListener('progress', function (e) {
    		grid.data = [{ status: 'Loading data: ' + e.loaded + ' of ' + (e.total || 'unknown') + ' bytes...'}];
	});
	xhr.addEventListener('load', function (e) {
    		grid.data = [{ status: 'Loading data ' + e.loaded + '...'}];
    		var openData = parseOpenData(JSON.parse(this.responseText));
    		grid.schema = openData.schema;
    		grid.data = openData.data;
		if(ecotype != ""){
                        grid.setFilter('Cultivar',ecotype);
                }
		if(genotype != ""){
			grid.setFilter('Genotype',genotype);
		}
		if(tissue != ""){
			grid.setFilter('Tissue', tissue);
                }
		if(project != ""){
                        grid.setFilter('Project', project);
                }
		if(treatment != ""){
			grid.setFilter('Treatment', treatment);
		}

	});
	grid.filters.number = function (value, filterFor) { //added by Hong
	        if (!filterFor) { return true; }
        	return value >= filterFor;
    	};
	xhr.open('GET', tb);
	xhr.send();
	grid.addEventListener('contextmenu', function (e) {
		 e.items.push({
			title: 'Add to online IGV',
			click: function(){
				if (e.cell.columnIndex == 0){
					var cell_val1 = e.cell.value;
					if (cell_val1.indexOf(" ") != -1){
						cell_val1 = cell_val1.split(" ")[0];
					}
					$(".labelbg li").eq(1).removeClass("active");
					$(".labelbg li").eq(3).addClass("active");
	                                $(".restablebg").hide();
                                	$(".outputigv").show();
                                	addalignment(cell_val1);
//                              	return;
                        	};
                	},
        	});
	});
	grid.addEventListener('contextmenu', function (e) {
		e.items.push({
			title: 'Link to NCBI',
        	        click: function(){
	                        if (e.cell.columnIndex == 0){
//                              alert(e.cell.value);
                        	        var cell_val = e.cell.value;
					if (cell_val.indexOf(" ") != -1){
						cell_val = cell_val.split(" ")[0];
					}
					//alert(typeof(e.cell.value)+"\n"+typeof(cell_val));
                                	if (cell_val.indexOf("GSM")==0){
                                        	window.open("https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc="+cell_val, "_blank");
                                	}else {
                                        	window.open("https://www.ncbi.nlm.nih.gov/sra/"+cell_val, "_blank");
                                	};

                        	};
                	},
        	});
	});

	var pagedown = document.getElementById('tabpagedown');
	pagedown.addEventListener('click', function(){
		var nowrow = Math.round(grid.scrollTop/24.0);
		grid.gotoRow(nowrow+100);
		nowrow += 100;
	});
	
	var pageup = document.getElementById('tabpageup');
	pageup.addEventListener('click', function(){
		var nowrow = Math.round(grid.scrollTop/24.0);
		if (nowrow<100){grid.gotoRow(0)}else{grid.gotoRow(nowrow-100)};
		nowrow = 0;
	});
	
	var pagetop = document.getElementById('tabpagetop');
	pagetop.addEventListener('click', function(){
		var nowrow = 0;
		grid.gotoRow(0);
	});
	
	var pageend = document.getElementById('tabpageend');
	pageend.addEventListener('click', function(){
		var nowrow = Math.round(grid.scrollHeight/24.0);
		grid.gotoRow(nowrow);
	});
};

function transpose(){
	var tb = getCookie('table');
	var tstb = tb + ".ts";
	var trans = getCookie('trans');
	if(trans== "yes"){
		if (tstb != ""){
			$("#tablebg").html("");
			$(".restablebg").show();
			loadtb(tstb, '', '', '', '');
		setCookie("trans", "no", 1);
		}
	}else{
		$("#tablebg").html("");
		$(".restablebg").show();
		loadtb2();
	};
};

function loadtb2(){
	var tb = getCookie('table');
	var ecotype = $('#fecotype').val();
	var genotype = $('#fgenotype').val();
        var tissue = $('#ftissue').val();
        var project = $('#fproject').val();
	var treatment = $('#ftreatment').val();
	$('#tablebg').html('');
	if (tb!=""){
		loadtb(tb, ecotype, genotype, tissue, project,treatment);
	}
	setCookie("trans", "yes", 1);
};


function violinplot(plotfile,plotydata,plotheight,plottitle){
	Plotly.d3.csv(plotfile, function(err, rows){
		function unpack(rows, key) {
			return rows.map(function(row) { return row[key]; });
		}
	var libs = unpack(rows, 'libID');
	var data = [{
	  type: 'violin',
	  x: unpack(rows, 'FPKMs'),
	  points: 'none',
	  text: libs,
	  hoverinfo: 'text',
	  box: {
	    visible: true
	  },
//	  line: {
//	    color: 'green',
//	  },
	  meanline: {
	    visible: true
	  },
	  transforms: [{
	     type: 'groupby',
		 groups: unpack(rows, plotydata)
	    }],
	  name: ''
	}]
	
	var layout = {
//	  height: plotheight,
	  title: {
	    text: plottitle,
		font: {
	        family: 'Helvetica',
	        size: 18
		}
	  },
	  yaxis: {
	    zeroline: false,
	    tickfont: {
	        family: 'Helvetica',
	        size: 12
	    },
	    font: {
	        family: 'Helvetica',
	        size: 16
	    }
	  },
	  xaxis: {
	    zeroline: false,
	    tickfont: {
	        family: 'Helvetica',
	        size: 12	
	    },
	    font: {
	        family: 'Helvetica',
	        size: 16
	    }
	  },
	width: 850,
	height: 600,
	}
	Plotly.plot('geneviolin', data, layout);
	}); 
};

function geneviolinplot(){
	var geneviolinfile = getCookie("geneviolin");
	if (geneviolinfile != ""){violinplot(geneviolinfile,"geneID",400,"FPKM distribution in all libraries");}
};

function libraryviolinplot(){
	var libraryviolinfile = getCookie("libraryviolin");
	if (libraryviolinfile != ""){
		violinplot(libraryviolinfile,"geneID",400,"FPKM distribution of all genes");
	};
};

//geneviolinplot("");

function plotstress(plotfile,geneID,plottag,plottitle){
	Plotly.d3.csv(plotfile, function(err, rows){
	function unpack(rows, key) {
		return rows.map(function(row) { return row[key]; });
	}
	var stress = unpack(rows, 'stress');
	var fpkmvalue = unpack(rows, 'value');
	var liblist = unpack(rows, 'library');
	var data = [];
	var alldata = [];
	alldata.push(['Sample',plottag,geneID]);
	for(var i=0; i<10;i++){
		var tmpval = fpkmvalue[i].split(';');
		var trace = {
			y: tmpval,
			boxpoints: 'all',
			name: stress[i],
			text: liblist[i].split(';'),
			hoverinfo: 'text',
			type: 'box',
			marker: {size:2},
		}
		data.push(trace);
		var tmplib = liblist[i].split(';');
		for (j=0;j<tmplib.length;j++){ 
			alldata.push([tmplib[j],stress[i],tmpval[j]]);
		}
	}
	for(var i=10;i<stress.length;i++){
		var tmpval = fpkmvalue[i].split(';');
		var trace = {
                        y: tmpval,
                        boxpoints: 'all',
                        name: stress[i],
                        type: 'box',
			text: liblist[i].split(';'),
			hoverinfo: 'text',
                        marker: {size:2},
			visible: 'legendonly'
                }
		data.push(trace);
		var tmplib = liblist[i].split(';');
		for (j=0;j<tmplib.length;j++){
               		alldata.push([tmplib[j],stress[i],tmpval[j]]);
		}
	}
	var layout = {
		title: {text: plottitle,
                        font: {size: 16}},
                width: 550,
                height: 600,
		hoverdistance:10,
                margin:{
                       t: 70,
                       l: 45,
                       r: 150,
                       b: 180,
                       autoexpand: false,
                      },
                yaxis:{
                      title: 'FPKM',
                      showline: true,
                      zeroline: false,
                      autorange: true,
                     },
                xaxis:{
                      showline: true,
                      zeroline: false,
                      showgrid: true,
                    },
                showlegend: true,
                legend:{font:{size:10},},
	};
	var config = {modeBarButtonsToAdd: [
                { name: 'downloadCsv',
                  title: 'Download data as csv',
                  icon: Plotly.Icons.disk,
                  click: function(){
                    var csvFile = alldata.map(e=>e.map(a=>'"'+((a||"").toString().replace(/"/gi,'""'))+'"').join(",")).join("\r\n");
                    var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
                    var link = document.createElement("a");
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", geneID+"_"+plottag+"_expression_levels"+ ".csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
          }
          }],
        };
	Plotly.newPlot(plottag, data, layout, config);
	var myPlot = document.getElementById(plottag);
	myPlot.on('plotly_click', function(eventdata){
               var pn='';
               var tmpdata=[],tmptext=[];

               for(var i=0;i<eventdata.points.length;i++){
                       //tn = eventdata.points[i].curveNumber;
                       pn = eventdata.points[i].data.name;
                       tmpdata = eventdata.points[i].data.y;
                       tmptext = eventdata.points[i].data.text;
               }
               var newid = window.open('','_blank','width=400,height=200,top=100,left=100,menubar=no,toolbar=no, location=no,directories=no,status=no,scrollbars=yes,resizable=yes');
               newid.document.write("<table border=\"1\" cellspacing=\"0\" cellpadding=\"0\" style=\"text-align:center;font-weight:400;withd:300px;\"><tr style=\"color:blue; font-weight:900;\"><td style=\"width:150px;\">Sample</td><td style=\"width:150px;\">FPKM</td></tr>");
               newid.document.write(pn+"</br>");
		tmpobj = sortobject(tmptext,tmpdata);
               for(var j=0;j<tmpdata.length;j++){
                       newid.document.write("<tr><td>"+tmpobj[j].key+"</td><td>"+Number(tmpobj[j].value).toFixed(1)+"</td></tr>");
               }
               newid.document.write("</table>");
               });

	});
}
function plotstress2(){
	var abiotic_file = getCookie('abioticbox');
	var biotic_file = getCookie('bioticbox');
	if(abiotic_file != ""){
		if(abiotic_file.indexOf("LOC") != -1){
			document.getElementById("abiotic").style.width = "530px";
			var genename = abiotic_file.split('/')[1].slice(0,-8);
			plotstress(abiotic_file, genename,"abiotic", "Expression levels of "+genename+" among different abiotic stress");
		}else{
			document.getElementById("abiotic").style.width = "1100px";
			plotAllformutli(abiotic_file, "abiotic", "Expression levels among different abiotic stress");
		}
	}
	if(biotic_file != ""){
		if(biotic_file.indexOf("LOC") != -1){
			document.getElementById("biotic").style.width = "530px";
			var genename = biotic_file.split('/')[1].slice(0,-7);
			plotstress(biotic_file, genename, "biotic", "Expression levels of "+genename+" among different biotic stress");
		}else{
			document.getElementById("biotic").style.width = "1100px";
			plotAllformutli(biotic_file, "biotic", "Expression levels among different biotic stress");
		}
	}
}

function plotline(plotfile){
	Plotly.d3.csv(plotfile, function(err, rows){
	function unpack(rows, key) {
		return rows.map(function(row) { return row[key]; });
	}
	var fpkmlib = unpack(rows, 'fpkmlibrary');
	var genes = unpack(rows, 'gene');
	var ll = fpkmlib[0].split('-').length/2;
	var data = new Array();
	for (var i=0;i<genes.length;i++){
		var trace = {
			y: fpkmlib[i].split('-').slice(0,ll),
			x: fpkmlib[i].split('-').slice(ll),
			mode: 'lines+markers',
			type: 'scatter',
			name: genes[i]
		};
		data.push(trace)
	}
	var layout={
		title:'Genes in selected libraries',
		autosize:false,
		width:700,
		height: 700,
		margin:{
			t:70,
			l:45,
			r:90,
			b:250,
		},
		yaxis:{
			title: 'FPKM',
			showline: true,
			zeroline: false,
		},
		xaxis:{
			automargin: true,
			showline: true,
			zeroline: false,
		},
		showlegend: true
	}
	Plotly.newPlot('lineplot', data, layout, {showSendToCloud: false});
	});
};

function plotline2(){
	var linefile = getCookie("line");
	if (linefile != ""){
		plotline(linefile);
	};
};

function plotbar(plotfile, geneID, plottag1, plottag2, plottitle1,plottitle2){  //plotbox
	Plotly.d3.csv(plotfile, function(err, rows){
		function unpack(rows, key) {
			return rows.map(function(row) { return row[key]; });
		}
		/*group,tagname,fpkm,infotag,se*/
		/*upregulated,experiment name[],experimental value*/
		/*downregulated,experiment name[],control value*/
		var projectlist = "";
		var group = unpack(rows, 'group');
		var tagname = unpack(rows, 'tagname');
		var stdstr = unpack(rows, 'se');
		var fpkmstr = unpack(rows, 'fpkm');
		var infotag = unpack(rows, 'infotag');
		var fc = unpack(rows, 'fc');
		var tag = plottag1.slice(0,-1);
		var contlib = unpack(rows, 'contlib');

		var infogroup = [];
		for(var i=0; i<tagname.length; i++){
			var tmp = tagname[i].split(';');
			var tmpinfo = infotag[i].split('_');
			for(var j=0; j<tmp.length; j++){
				var pr = tmp[j].split('_');
				var comstr = tag + '_' + pr[1];
				var com = '<div class="toigvlist" title="'+ pr[0] +'" onclick="addtoigvlist(\'' + comstr + '\');">' + pr[0] + '</div>\n';
				projectlist += com;
			}
			infogroup.push(tmpinfo[1]);
		}
		if(tag == "barplot"){
			$("#mutantside").remove();
			//$("#mutanttoigv").remove();
			$("#barplot2").after('<div class="resplotmutant igvside" id="mutantside"><span onclick="gotoigv2();">To IGV</span></div>');
			//$("#mutanttoigv").before('<div class="resplotmutant igvside" id="mutantside"><span onclick="gotoigv2();">To IGV</span></div>');
			$("#mutanttoigv").html(projectlist);
		}
		if(tag == "treatment"){
			$("#treatside").remove();
			//$("#treattoigv").remove();
			//$("#treatment2").after('<div class="resplottreat toigv" id="treattoigv"></div>');
			$("#treatment2").after('<div class="resplottreat igvside" id="treatside"><span onclick="gotoigv3();">To IGV</span></div>');
			$("#treattoigv").html(projectlist);
		}
		//new format: 3row: hander,up,down
		function maketrace(tagstr,valstr,sestr,groupstr,cklibstr){
			var data = new Array();
			if(tagstr == ""){
				return data;
			}else{
			var tagarr = tagstr.split(';',10);
			var valarr = valstr.split('_');
			var searr = sestr.split('_');
			var libarr = cklibstr.split('_');
			var garr = groupstr.split('_'); //treatment,mock
			for (var i=0;i<valarr.length;i++){
				var trace = {
					y: valarr[i].split(';',10).map(current => Number(current).toFixed(2)),
					x: tagarr,
					name: garr[i],
					type: 'bar',
					text: libarr[i].split(';',10),
					width: 0.4,
					error_y: {array: searr[i].split(';',10).map(current => Number(current).toFixed(2)),
						  thickness: 1,},
				};
				data.push(trace);
			}
			
			return data;}
		}
		//alert(tagname[0]);
		var dataup = maketrace(tagname[0],fpkmstr[0],stdstr[0],infotag[0],contlib[0]);
		var datadown = maketrace(tagname[1],fpkmstr[1],stdstr[1],infotag[1],contlib[1]);
		function toarr(tagstr,valstr, stdstr,gtag, fcstr){
			var alldata = new Array();
			if(tagstr==""){
				return alldata;
			}else{
			var tagarr = tagstr.split(';');
			var valarr = valstr.split('_');
			var starr = stdstr.split('_');
			var gtagarr = gtag.split('_'); //mock_treatment
			alldata.push(['project','groupName',gtagarr[0]+'_FPKMmean',gtagarr[1]+'_FPKMmean',gtagarr[0]+'_STD',gtagarr[1]+'_STD', 'logFoldChange']);
			var mockval = valarr[0].split(';');
			var mockstd = starr[0].split(';');
			var treatval = valarr[1].split(';');
			var treatstd = starr[1].split(';');
			var lfc = fcstr.split(';');
			for (var i=0;i<mockval.length;i++){
				var tmptag = tagarr[i].split('_');
				alldata.push([tmptag[1].split('\.',1),tagarr[i],mockval[i],treatval[i],mockstd[i],treatstd[i],lfc[i]]);
			
			}
			return alldata;}
		}
		var allup = toarr(tagname[0],fpkmstr[0],stdstr[0],infotag[0],fc[0]);
		var alldown = toarr(tagname[1],fpkmstr[1],stdstr[1],infotag[1],fc[1]);
		function getlayout(title){
			var layout = {
				title: {
					text: title,
					font: {
						family: 'Helvetica',
						size: 16,
					}
				},
				width: 500,
				height: 600,
				margin:{
                        		t:70,
	                        	l:45,
        	                	r:120,
					b: 220,
					autoexpand: false,
                		},
	                	yaxis:{
	                        	title: 'FPKM',
        	                	showline: true,
                	        	zeroline: true,
					
	                	},
	                	xaxis:{
        	                	automargin: true,
                	        	showline: false,
                        		zeroline: false,
					showgrid: true,
					showdividers: true,
	                	},
                		showlegend: true,
				legend:{x: 1,
					font:{size:10},
				}
        		};
			return layout;
		}
		var uplay = getlayout(plottitle1);
		var downlay = getlayout(plottitle2);
		function getconfig(filename,dataarr){
			var config = {modeBarButtonsToAdd: [
                		{name: 'downloadCsv', 
                 	 	title: 'Download data as csv', 
                  		icon: Plotly.Icons.disk, 
                  		click: function(){
                    			var csvFile = dataarr.map(e=>e.map(a=>'"'+((a||"").toString().replace(/"/gi,'""'))+'"').join(",")).join("\r\n");
                    			var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
                    			var link = document.createElement("a");
                   	 		var url = URL.createObjectURL(blob);
                    			link.setAttribute("href", url);
                    			link.setAttribute("download", filename+"regulated"+ ".csv");
			                link.style.visibility = 'hidden';
			                document.body.appendChild(link);
                    			link.click();
                    			document.body.removeChild(link);
          			}
          			}],
        		};
			return config;
		}
		
		var upconfig = getconfig(geneID +"_" + infogroup[0]+"_"+group[0],allup);
		var downconfig = getconfig(geneID +"_" + infogroup[1]+"_"+group[1],alldown);
		Plotly.newPlot(plottag1, dataup, uplay, upconfig);
		Plotly.newPlot(plottag2, datadown,downlay, downconfig);

		var taglist = [plottag1,plottag2];
		for(var i=0;i<taglist.length;i++){  //for click event
			var myplot = document.getElementById(taglist[i]);
			var X, xx;
			
			myplot.addEventListener('mousemove', (event) => {
                        	X = event.x;
				xx = event.offsetX;
                	});
			myplot.on('plotly_click',function(eventdata){
  				var xa = eventdata.points[0].xaxis;
			 	var marginL = myplot._fullLayout.margin.l;
				var marginR = myplot._fullLayout.margin.r;
 				var x = xx - marginL;
				//alert(X+"<br>"+marginL+"<br>"+xx);
				//alert(xa.p2d(X -marginL));
 				var wt= eventdata.points[0].data.y;
				var wtx = eventdata.points[0].data.x, mtx=eventdata.points[1].data.x;
				var mt = eventdata.points[1].data.y;
				var wtt =eventdata.points[0].data.text;
				var mtt = eventdata.points[1].data.text;
				var tmpmt=[],tmpwt=[];
				var pn='';
				//alert(mtt);
				//alert(xa.p2d(x));
				var wg = eventdata.points[0].data.name, mg=eventdata.points[1].data.name;
				for(var j=0;j<wt.length;j++){
					if(wtx[j]==xa.p2d(x) || mtx[j]==xa.p2d(x)){
						tmpmt = mtt[j].split("<br>");
						tmpwt = wtt[j].split("<br>");
						pn=wtx[j];
						//alert(tmpwt);
					}
  				}
				//alert(tmpmt);
 				var newid = window.open('','_blank','width=400,height=200,top=100,left=100,menubar=no,toolbar=no,location=no,directories=no,status=no,scrollbars=yes,resizable=yes');
				newid.document.write("<table border=\"1\" cellspacing=\"0\" cellpadding=\"0\" style=\"text-align:center;font-weight:400;withd:400px;\"><tr style=\"color:blue; font-weight:900;\"><td style=\"width:100px;\">group</td><td style=\"width:150px;\">Sample</td><td style=\"width:150px;\">FPKM</td></tr>");
				newid.document.write(pn+"</br>");
  
				for(var j=0;j<tmpmt.length;j++){
					var tmp=tmpmt[j].split(':');
					newid.document.write("<tr><td>"+mg+"</td><td>"+tmp[0]+"</td><td>"+Number(tmp[1]).toFixed(1)+"</td></tr>");
				}
				for(var j=0;j<tmpwt.length;j++){
					var tmp=tmpwt[j].split(':');
					newid.document.write("<tr><td>"+wg+"</td><td>"+tmp[0]+"</td><td>"+Number(tmp[1]).toFixed(1)+"</td></tr>");
				}
				newid.document.write("</table>");
			});
		}
	});	
}


function plotbox2(){ //added by Hong
	var treatbox = getCookie("treatbox");
	var mutantbox = getCookie("mutantbox");
	var tissuebox = getCookie("tissuebox");
	var alltissue = getCookie("tissueall");
	if (treatbox != ""){
		var genename = treatbox.split('/')[1].slice(0,-5);
//		alert(scatterfile);
		plotbar(treatbox, genename, "treatment1", "treatment2","Up-regulated treatments", "Down-regulated treatments");
	};
	if (mutantbox != ""){
		var genename = mutantbox.split('/')[1].slice(0,-5);
		plotbar(mutantbox,genename,"barplot1","barplot2","Up-regulated mutants", "Down-regulated mutants");
	};
	if (tissuebox != ""){
		var genename = tissuebox.split('/')[1].slice(0,-6);
		plottissue(tissuebox, genename, "tissuebox", "Expression levels distribution in top developmental stages");
	}
	if (alltissue != ""){
		if(alltissue.indexOf("LOC") != -1){ //single gene
			var genename = alltissue.split('/')[1].slice(0,-6);
			plottissue(alltissue, genename, "tissueall", "Expression levels of "+genename+" among different tissues");
		}else{ //mutliple genes
			plotAllformutli(alltissue,"tissueall","Expression levels among different tissues");
		}
	}
};

function plottissue(plotfile, geneID, plottag, plottitle){
	Plotly.d3.csv(plotfile, function(err, rows){
                function unpack(rows, key) {
                        return rows.map(function(row) { return row[key]; });
                }
	//tissue,value
	var tissue = unpack(rows, 'tissue');
	var value = unpack(rows, 'value');
	var liblist = unpack(rows, 'library');
	var alldata = [];
	var tag = plottag;
	var data = new Array();
	var projectlist = "";
	alldata.push(['Sample','Tissue/Satge',geneID]);
	if(tag == "tissuebox"){
		for (var i=0;i<10;i++){
			pr = tissue[i].split('_');
			var trace = {
                        	y: value[i].split(';'),
                    	   	boxpoints: 'all',
                        	name: pr[1],
				text: liblist[i].split(';'),
				hoverinfo: 'text',
                        //boxmean: 'sd',
                        	type: 'box',
                        	marker: {size:2},
                	};
			data.push(trace);
                	var comstr = tag + '_' + pr[0];
                	var com = '<div class="toigvlist" title="'+ pr[1] +'" onclick="addtoigvlist(\'' + comstr + '\');">' + pr[1] + '</div>\n';
                	projectlist += com;
			var yall = value[i].split(';');
			var liball = liblist[i].split(';');
			for(var j=0;j<yall.length;j++){
                		alldata.push([liball[j],pr[1],yall[j]]);
			}
		}
		for (var i=10;i<tissue.length;i++){
			var pr = tissue[i].split('_');
                	var trace = {
                        	y: value[i].split(';'),
                        	name: pr[1],
				text: liblist[i].split(';'),
				hoverinfo: 'text',
                        //boxmean: 'sd',
                        	type: 'box',
                        	marker: {size:2},
                       		visible: "legendonly"         //only legend not draw
                	};
                	data.push(trace);
                	var comstr = tag + "_" + pr[0];
                	var com = '<div class="toigvlist" title="'+ pr[1] +'" onclick="addtoigvlist(\'' + comstr + '\');">' + pr[1] + '</div>\n';
                	projectlist += com;
			var yall = value[i].split(';');
			var liball = liblist[i].split(';');
			for(var j=0;j<yall.length;j++){
                		alldata.push([liball[j],pr[1],yall[j]]);
			}
       		 }
	}else{
		var xx = [];
		var yy = [];
		for (var i=0;i<tissue.length;i++){
			var tmp = value[i].split(';');
			var libtmp = liblist[i].split(';');
			yy.push(...tmp);
			//alert(tissue[i]);
			for(var j=0;j<tmp.length;j++){
				xx.push(tissue[i]);
				alldata.push([libtmp[j],tissue[i],tmp[j]]);
			}
		
			var trace = {
				y: tmp,         //yy for only one color in this plot
				x: tissue[i],  //xx
				boxpoints: 'all',
				name: tissue[i],
				text: libtmp,
				hoverinfo: 'text',
			//boxmean: 'sd',
				type: 'box',
				marker: {size:2},
			};
			data.push(trace);
		}
	}
	if(tag == "tissuebox"){
		$('#tissueside').remove();
		$('#tissuebox').after('<div class="resplottissue igvside" id="tissueside"><span onclick="gotoigv1();">To IGV</span></div>');
		$('#tissuetoigv').html(projectlist);
	}
	function getlayout(tag){
		var legendtag = '';
		var rl = 0;
		if(tag == "tissuebox"){
			legendtag = true;
			rl = 140;
		}else{
			legendtag = false;
			rl = 80;
		}
		var layout = {
			title: {text: plottitle,
				font: {size: 16}},
			width: 500,
                	height: 600,
			hoverdistance:10,
                	margin:{
                       		t: 70,
                      		l: 40,
                       		r: rl,
				b: 180,
		       		autoexpand: false,
                      	},
			yaxis:{
                      		title: 'FPKM',
	                      showline: true,
        	              zeroline: false,
			      autorange: true,
                     	},
	                xaxis:{
        	              showline: true,
                	      zeroline: false,
			      showgrid: true,
			     tickangle:50,
        	            },
			showlegend: legendtag,
			legend:{font:{size:10},},
		};
		return layout;
	}
	var config = {modeBarButtonsToAdd: [
  		{ name: 'downloadCsv', 
		  title: 'Download data as csv', 
		  icon: Plotly.Icons.disk, 
		  click: function(){
		    var csvFile = alldata.map(e=>e.map(a=>'"'+((a||"").toString().replace(/"/gi,'""'))+'"').join(",")).join("\r\n");
		    var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
		    var link = document.createElement("a");
		    var url = URL.createObjectURL(blob);
		    //var url = "https://plantrnadb.com//athrna/"+csvFile;
		    //alert(url);
		    link.setAttribute("href", url);
		    link.setAttribute("download", geneID+"_tissue_expression"+ ".csv");
		    link.style.visibility = 'hidden';
		    document.body.appendChild(link);
		    link.click();
		    document.body.removeChild(link);
	  }
	  }],
	};
	var layout = getlayout(tag);
	var myPlot = document.getElementById(plottag);
	Plotly.newPlot(plottag, data, layout, config);
	myPlot.on('plotly_click', function(eventdata){
       		var pn='';
		var tmpdata=[],tmptext=[];
	
  		for(var i=0;i<eventdata.points.length;i++){
    			//tn = eventdata.points[i].curveNumber;
			pn = eventdata.points[i].data.name;
			tmpdata = eventdata.points[i].data.y;
			tmptext = eventdata.points[i].data.text;
		}
    		var newid = window.open('','_blank','width=400,height=200,menubar=no,toolbar=no, location=no,directories=no,status=no,scrollbars=yes,resizable=yes');
  		newid.document.write("<table border=\"1\" cellspacing=\"0\" cellpadding=\"0\" style=\"text-align:center;font-weight:400;withd:300px;\"><tr style=\"color:blue; font-weight:900;\"><td style=\"width:150px;\">Sample</td><td style=\"width:150px;\">FPKM</td></tr>");
    		newid.document.write(pn+"</br>");
		tmpobj = sortobject(tmptext,tmpdata);
    		for(var j=0;j<tmpobj.length;j++){
			newid.document.write("<tr><td>"+tmpobj[j].key+"</td><td>"+Number(tmpobj[j].value).toFixed(1)+"</td></tr>");
      			//newid.document.write("<tr><td>"+tmptext[j]+"</td><td>"+tmpdata[j]+"</td></tr>");
  		}
     		newid.document.write("</table>");
		});
	});
}
function sortobject(arr1,arr2,arr3=''){ //arr1 is library list, arr2 is fpkm list
	function compare(property){
        	return function(obj1,obj2){
             	var value1 = obj1[property];
             	var value2 = obj2[property];
             	return value1 - value2;     // 升序
         	}
	}
	var obj = [];
	if(arr3==''){
	for(var i=0;i<arr1.length;i++){
		var tmp={'key':arr1[i],'value':arr2[i]};
		obj.push(tmp);	
	}
	}else{
	for(var i=0;i<arr1.length;i++){
		var tmp={'key':arr1[i],'value':arr2[i],'xn':arr3[i]};
		obj.push(tmp);
	}
	}
	obj.sort(compare("value"));
	return obj;
}
function plotAllformutli(plotfile, plottag, plottitle){
	Plotly.d3.csv(plotfile, function(err, rows){
		function unpack(rows, key) {
			return rows.map(function(row) { return row[key]; });
		}
	//dataformat: geneID, tissue, value
	var tissue = unpack(rows, 'tissue');
	var value = unpack(rows, 'value');
	var geneName = unpack(rows, 'geneID');
	var liblist = unpack(rows, 'library')
	var alldata = [];
	var data = [];
	var xas = [];
	var yas = [];
	alldata.push(['geneID','Sample',plottag,'FPKM'])
	for(var i=0; i<geneName.length; i++){
		var xx = 'x'+(i+1);
		var yx = 'y'+(i+1);
		var xxx = 'xaxis' + (i+1);
		var yxx = 'yaxis' + (i+1);
		xas.push(xxx);
		yas.push(yxx);
		var tmpts = tissue[i].split(';');
		var tmpvl = value[i].split(';');
		var trace = {
			x: tmpts,
			y: tmpvl,
			text: liblist[i].split(';'),
			name: geneName[i],
			boxpoints: 'all',
			xaxis: xx,
			yaxis: yx,
			type: 'box',
			marker: {size:2},
			hoverinfo: 'text',
		};
		data.push(trace);
		var tmplib = liblist[i].split(';');
		for(var j=0; j<tmpts.length; j++){
			alldata.push([geneName[i],tmplib[j],tmpts[j],tmpvl[j]]);
		}
	}
	var rownum = Math.ceil(geneName.length/2);
	var hg = 500 * rownum;
	function getanno(row,namearr){
		var anno = [];
		var countnum = namearr.length;
		var per = 1/row;
		var xarr = [0.25, 0.75];
		for(var y=0;y<row;y++){
			for(var i=0; i<2;i++){
				if(y*2+i<countnum){
					var peranno = {x: xarr[i],
						y: 1-y*(per+0.1),
						xref:'paper',
						yref: 'paper', 
        					xanchor: 'center', 
       						yanchor: 'bottom', 
					        text:namearr[y*2+i], 
					        showarrow: false

					};
					anno.push(peranno);
				}
			}
		}
		return anno;
	}
	var annotext = getanno(rownum,geneName);
	function getlay(xas,yas){
		var layout= {
			title: plottitle,
			width: 1100,
			grid: {rows: rownum, columns: 2, pattern: 'independent',},
			height: hg,
			margin:{
				r: 40,
				l: 50,
				t: 50,
				b: 120,
			},
		//xaxis:{showgrid: true},
			legend:{font:{size:12},},
			annotations: annotext,
		};
		var xt = {zeroline: false,showline: true,tickangle: 40,showgrid:true,tickfont: { size: 10 },automargin: false,ticklen:2};
		var yt = {title: 'FPKM',zeroline: false,showline: true};
		for(i=0; i<xas.length;i++){
			layout[xas[i]] = xt;
			layout[yas[i]] = yt;
		}
		return layout;
	}
	var layout1 = getlay(xas,yas);
	var config = {modeBarButtonsToAdd: [
                { name: 'downloadCsv',
                  title: 'Download data as csv',
                  icon: Plotly.Icons.disk,
                  click: function(){
                    var csvFile = alldata.map(e=>e.map(a=>'"'+((a||"").toString().replace(/"/gi,'""'))+'"').join(",")).join("\r\n");
                    var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
                    var link = document.createElement("a");
                    var url = URL.createObjectURL(blob);
                    //var url = "https://plantrnadb.com//athrna/"+csvFile;
                    //alert(url);
                    link.setAttribute("href", url);
                    link.setAttribute("download", plottag+"expression_levels"+ ".csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
          }
          }],
        };
	Plotly.newPlot(plottag, data, layout1, config);
	var myPlot = document.getElementById(plottag);
	var X,xx;
 	myPlot.addEventListener('mousemove', (event) => {
		X = event.x;
		xx = event.offsetX;
	});
        myPlot.on('plotly_click', function(eventdata){
                var pn='',xa='',xn='';
                var tmpdata=[],tmptext=[];
		var marginL = myPlot._fullLayout.margin.l;
		var x = xx - marginL;
                for(var i=0;i<eventdata.points.length;i++){
                        //tn = eventdata.points[i].curveNumber;
			xa = eventdata.points[i].xaxis;
			xn = eventdata.points[i].data.x;
                        pn = eventdata.points[i].data.name;
                        tmpdata = eventdata.points[i].data.y;
                        tmptext = eventdata.points[i].data.text;
                }
                var newid = window.open('','_blank','width=400,height=200,menubar=no,toolbar=no, location=no,directories=no,status=no,scrollbars=yes,resizable=yes');
                newid.document.write("<table border=\"1\" cellspacing=\"0\" cellpadding=\"0\" style=\"text-align:center;font-weight:400;withd:300px;\"><tr style=\"color:blue; font-weight:900;\"><td style=\"width:150px;\">Sample</td><td style=\"width:150px;\">FPKM</td></tr>");
                newid.document.write(pn+": "+xa.p2d(x%500)+"</br>");
		tmpobj = sortobject(tmptext,tmpdata, xn);
		//alert(xx+":"+x+"_"+marginL);
                for(var j=0;j<tmpobj.length;j++){
			if(tmpobj[j].xn==xa.p2d(x%500)){ //width/column
                 	       newid.document.write("<tr><td>"+tmpobj[j].key+"</td><td>"+tmpobj[j].value+"</td></tr>");
			}
                }
                newid.document.write("</table>");
                });

	});
}

//advabce Filter
$("#ffgenotype").autocomplete({
        source:"autocompletegenotype.php",
        minLength: 0,
}).bind('focus', function () {
        $(this).autocomplete("search");
    });

// Table Filter
$("#fecotype").autocomplete({
source:"autocompleteecotype.php",
minLength: 0,
}).bind('focus', function () {
$(this).autocomplete("search");
    });
$("#fgenotype").autocomplete({
	source:"autocompletegenotype.php",
	minLength: 0,
}).bind('focus', function () {
        $(this).autocomplete("search");
    });
$("#ftissue").autocomplete({
	source:"autocompletets.php",
	minLength: 0,
}).bind('focus', function () {
        $(this).autocomplete("search");
    });
$("#fproject").autocomplete({
	source: "autocompletestudy.php",
	minLength: 0,
}).bind('focus', function () {
        $(this).autocomplete("search");
    });
$("#ftreatment").autocomplete({
        source: "autocompletetreatment_filter.php",
        minLength: 0,
}).bind('focus', function () {
        $(this).autocomplete("search");
    });
//IGV
$("#igvlibid").autocomplete({
source: "autocompletelib.php",
//source: availableTags,
minLength: 0,
}).bind('focus', function () {
        $(this).autocomplete("search");
    });


$("#igvgeneid").autocomplete({
source: "autocompletegene.php",
//source: availableTags,
minLength: 0,
});
$("#igvgeneid").on('focus', function () {
	$(this).autocomplete("search");	
});
$("#studyid").autocomplete({
source: "autocompletestudy.php",
//source: availableTags,
minLength: 0,
}).bind('focus', function () {
        $(this).autocomplete("search");
    });

$('#tissueid').autocomplete({
source: "autocompletetissue.php",
minLength: 0,
}).bind('focus',function(){
	$(this).autocomplete("search");
   });

$('#mutantid').autocomplete({
source: "autocompletemutant.php",
minLength: 0,
}).bind('focus',function(){
	$(this).autocomplete("search");
   });

$('#treatid').autocomplete({
source: "autocompletetreatment.php",
minLength: 0,
}).bind('focus',function(){
        $(this).autocomplete("search");
   });

function loadigv(){
	var div = $("#showigv"),
	options = {
		showNavigation: true,
		showRuler: true,
		reference: {
			"id": "TAIR10",
			"name": "TAIR10",
			"fastaURL": "data/MSU7_with_chrMC.fa",
			"indexURL": "data/MSU7_with_chrMC.fa.fai",
		},
		
		tracks: [
			{
				name: "GFF",
				type: "annotation",
				format: "gff3",
				sourceType: "file",
				url: "data/MSU7.sorted.gff3.gz",
				indexURL: "data/MSU7.sorted.gff3.gz.tbi",
				order: "Number.MAX_VALUE",
				visibilityWindow: 10000000,
				displayMode: "EXPANDED"
			},
		]
		
	};

igv.createBrowser(div, options);
};

function addalignment2(){
	var libID = $("#igvlibid").val();
	var bamfile = "https://zhailab.bio.sustech.edu.cn/igvonline/bam/" + libID.slice(0,6) + "/" + libID + ".rm.bam";
	$.ajax(bamfile, {
		type : 'HEAD',
		async:false,
		timeout: 1000,
		success: function(){
			igv.browser.loadTrack({
				type: "alignment",
				format: "bam",
				name: libID,
				url: bamfile,
				indexURL: bamfile+".bai",
				height: 100,
				minHeight: 50,
				maxHeight: 200,
				autoHeight:true,
				visibilityWindow: 50000,
				colorBy: "strand",
				order: "Number.MAX_VALUE",
			});
		},
		error: function(){
			alert("LibraryID not exist"); 
		}
	});
};
function addalignment(vv){
	var bamfile = "https://zhailab.bio.sustech.edu.cn/igvonline/bam/"+vv.slice(0,6) +"/"+ vv +".rm.bam";
	igv.browser.loadTrack({
		type: "alignment",
                format: "bam",
                name: vv,
                url: bamfile,
                indexURL: bamfile + ".bai",
                height: 100,
                minHeight: 50,
                maxHeight: 200,
                autoHeight:true,
                visibilityWindow: 50000,
                colorBy: "strand",
                order: "Number.MAX_VALUE",
	});
};
function addalignmentandzoomin(){
	var libv = $("#igvlibid").val();
        var geneID = $("#igvgeneid").val();  //added by Hong
	var projectID = $("#studyid").val(); //added by Hong
	var tissuePro = $("#tissueid").val(); //added by Hong
	var mutantPro = $("#mutantid").val(); //added by Hong
	var treatPro = $("#treatid").val(); //added by Hong
        if(libv != "" && geneID == ""){
		addalignment2();
		if(projectID != ""){
			$.get("find_studylib.php?studyid="+projectID, function(data,status){
				if (data!=""){
                                        var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
                                }
			});
		}
	}
	if(libv == "" && geneID != ""){
		zoomin();
		if(projectID != ""){
			$.get("find_studylib.php?studyid="+projectID, function(data,status){
			if (data!=""){
				var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
				}
			});
		}
		if(mutantPro != ""){
                        $.get("find_mutant.php?studyid="+mutantPro, function(data,status){
                                if(data!=""){
                                        var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
                                }
                        });
                }
                if(tissuePro != ""){
                        $.get("find_tissue.php?studyid="+tissuePro,function(data,status){
                                if (data!=""){
                                        var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
                                }
                        });
                }
                if(treatPro != ""){
                        $.get("find_treatment.php?studyid="+treatPro,function(data,status){
                                if (data!=""){
                                        var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
                                }
                        });
                }
	}
	if(libv != "" && geneID != ""){
		addalignment2();
		zoomin();
		if(projectID != ""){
			$.get("find_studylib.php?studyid="+projectID, function(data,status){
                        if (data!=""){
                                var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
                                }
                        });
		}
	}	
	if(libv == "" && geneID == ""){
		if (projectID != ""){
			$.get("find_studylib.php?studyid="+projectID, function(data,status){
			if (data!=""){
				var libs = data.split(",").filter(Boolean);
				for (var i=0;i<libs.length;i++){
					addalignment(libs[i]);
				};
			}
			});
		}
		if(mutantPro != ""){
                        $.get("find_mutant.php?studyid="+mutantPro, function(data,status){
                                if(data!=""){
                                        var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
                                }
                        });
                }
                if(tissuePro != ""){
                        $.get("find_tissue.php?studyid="+tissuePro,function(data,status){
                                if (data!=""){
                                        var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
                                }
                        });
                }
                if(treatPro != ""){
                        $.get("find_treatment.php?studyid="+treatPro,function(data,status){
                                if (data!=""){
                                        var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
                                }
                        });
                }
	}
};

function addtoigvlist(command){
	var com = command.split('_'); //tag,projectID
	var tag = com[0];
	var project = com[1];
	if(project != ""){
		$(".labelbg li").eq(2).removeClass("active");
	        $(".labelbg li").eq(4).addClass("active");
        	$(".resplotbg").hide();
        	$(".outputigv").show();
        	var genestr = getCookie("info");
		var genename = genestr.split('/')[1].slice(0,-5);
		//alert(genename);
		$.get("find_locus.php?geneid="+genename, function(data,status){
			if (data==""){
				alert("cannot find locus");
			}else{
                        	igv.browser.search(data);
                	};
        	});
		
		if(tag == "tissuebox"){  //tissue id to igv
			$.get("find_tissue.php?studyid="+project,function(data,status){
				if (data!=""){
					var libs = data.split(",").filter(Boolean);
					for (var i=0;i<libs.length;i++){
						addalignment(libs[i]);
					};
				}
			});
		}
		if(tag == "barplot"){ //mutant to igv
			$.get("find_mutant.php?studyid="+project, function(data,status){
                                if(data!=""){
                                        var libs = data.split(",").filter(Boolean);
                                        for (var i=0;i<libs.length;i++){
                                                addalignment(libs[i]);
                                        };
                                }
                        });
		}
		if(tag == "treatment"){
			$.get("find_treatment.php?studyid="+project,function(data,status){
				if (data!=""){
					var libs = data.split(",").filter(Boolean);
					for (var i=0;i<libs.length;i++){
						addalignment(libs[i]);
					};
				}
			});
		}
	}
}

function zoomin(){
	var vv = $("#igvgeneid").val();
	$.get("find_locus.php?geneid="+vv, function(data,status){
		if (data==""){
			alert("cannot find locus");
		}else{
			igv.browser.search(data);
		};
	});
};
function zoomin2(location){
        $(".labelbg li").eq(0).removeClass("active");
        $(".labelbg li").eq(4).addClass("active");
        $(".resinfo").hide();
        $(".outputigv").show();
        igv.browser.search(location);
};


function addhistory(content){
	var histxt = getCookie("history");
	if (content!=""){
		var his_arr = histxt.split("@");
		for (var i = 0; i < his_arr.length; i++){
			if (his_arr[i]==content){
				his_arr.splice(i,1);
				break
			};
		};
		if (his_arr.length>19){
			his_arr.splice(0,1);
		};
		his_arr.push(content);
		histxt = his_arr.join("@");
		setCookie("history",histxt,365);
	};
	if (histxt!=""){
		var his_arr = histxt.split("@");
		his_arr = his_arr.reverse();
		his_html = "";
		for (var i = 0; i < his_arr.length; i++){
			content = his_arr[i];
			his_html += '<div class="hsrecord" title="' + content + '" onclick="search2(\'' + content + '\')">' + content + '</div>\n';
		};
		$("#historyside").html(his_html);
	};
};

addhistory("");

function getRequest(){
	var locUrl = location.search;
	var gene = new String;
	if(locUrl.indexOf("?") != -1){
		var strs = locUrl.substr(1);
		gene = strs.split("=")[1];
	}
	return gene;
}

$(document).ready(function(){
	$(".outputigv").show();
	loadigv();
	setTimeout(function(){$(".outputigv").hide()}, 500);
//	setTimeout(function(){$(".waiting").hide()}, 500);
});

$("#tbdl").click(function(){
		window.open(getCookie("table").replace("json","xls"));
});

$(document).ready(function(){
	if (getCookie("share") == 'yes'){
		setCookie("newtable", "yes", 1);
		setCookie("newigv", "yes", 1);
		setCookie("newplot", "yes", 1);
		setCookie("newinfo", "yes", 1);
		setCookie("stype", "no", 1);
		$(".outputlabelsbg").show();
		$(".labelbg li").eq(0).click();
		$("#resinfo").html("");
		//alert(getCookie("info"));
		$("#resinfo").load(getCookie("info"), function(responseTxt,statusTxt,xhr){
			if(statusTxt == "error"){
				var geneinfo = getRequest();
                        	var cont = geneinfo + "/" +"0/max";
                        	$("#resinfo").load("Search.php?query="+cont);
			}
		});
	};
});
function plotcoex(filein,taggene){
        Plotly.d3.csv(filein, function(err, rows){
        function unpack(rows, key) {
                return rows.map(function(row) { return row[key]; });
        }
        var fromnode = unpack(rows, 'from');
        var tonode = unpack(rows, 'to');
        var weight = unpack(rows, 'weight');
        var fromid = unpack(rows, 'from.id');
        var toid = unpack(rows, 'to.id');
        var fromsy = unpack(rows, 'fromsymbol');
        var tosy = unpack(rows, 'tosymbol');
        fetch('js/cytoscape/cy-style.json', {mode: 'no-cors'}).then(function(res) {return res.json()}).then(function(cystyle){

        var cy = cytoscape({
                        container:document.getElementById('resconet'),
                        style: cystyle,//[{selector: 'node',
                                //style:{'background-color': '#555','label': 'data(name)',
                                //      "selection-box-color": "#AAD8FF",
                                //      "selection-box-border-color": "#8BB0D0",
                                //      "selection-box-opacity": "0.5"}}],
                        //elements:[],
                });
                var data = [];
	var fcol="",tcol="";
        for(i=0;i<fromnode.length;i++){
		if(fromnode[i]==taggene){
			fcol = "FCFF33";
		}else{
			fcol = "#f5972c";
		}
		if(tonode[i]==taggene){
			tcol = "FCFF33";
		}else{
			tcol = "#f5972c";
		}
                 data.push({
                        data:{id: fromid[i],
				name: fromsy[i],
                                gene_name: fromnode[i],
				node_type: "linked",
				color: fcol},
                                group:'nodes',
                                query: true,
                                gene: true});
                data.push({
                        data:{id: toid[i],
				name: tosy[i],
                                gene_name: tonode[i],
				node_type: "linked",
				color: tcol},
                                group:'nodes',
                                query: false,
                                gene: true});
                data.push({group: "edges",
                          grabbed: false,
                          grabbable: true,
                          data: {
                                source: fromid[i],
                                target: toid[i],
                                weight: Number(weight[i]),
                                id: "e"+i,
                                intn: true,
                                group: "coexp",
                        }
                });
        }
        cy.add(data);
        //alert(cy.elements);
        cy.layout({name:'cose',
                idealEdgeLength: 100,
                nodeoverlap:20,
                refresh: 20,
                fit: true,
                padding: 30,
                randomize: false,
                componentSpacing: 100,
                nodeRupulsion: 400000,
                edgeElasticity:100,
                nestingFactor: 5,
                gravity: 80,
                numIter: 1000,
                initialTemp:200,
                coolingFactor: 0.95,
                minTemp:1.0
        }).run();});
});
}
function loadcotable(filein){

        Plotly.d3.csv(filein, function(err, rows){
        function unpack(rows, key) {
                return rows.map(function(row) { return row[key]; });
        }
        var doc = document.getElementById("rescotable");
        var gene = unpack(rows, "gene");
        var wg = unpack(rows, "weight");
        var sb = unpack(rows, "symbol");
	var als = unpack(rows, "alias");
        var anno = unpack(rows, "annotation");
        var tab = "<div class=\"table_box\"><table><thead><tr><th><div>GeneID</div></th><th><div>WGCNA Correlation*</div></th><th><div>Symbol</div></th><th style=\"width:150px\"><div>Alias</div></th><th style=\"width:400px\"><div>Description</div></th></tr></thead></table><div class=\"table_tbody_box\"><table><tbody>";
        for(var i=0; i<20;i++){ //only display top 20
                tab += "<tr><td>"+gene[i]+"</td><td>"+Number(wg[i]).toFixed(4)+"</td><td>"+sb[i]+"</td><td style=\"width:150px\">"+als[i]+"</td><td style=\"width:400px\">"+anno[i]+"</td></tr>";
        }
        tab += "</tbody></table></div><p style=\"margin-top:20px;margin-botton:30px;height:60px;text-align:left;font-size:14px;\">The \"WGCNA Correlation*\" column refers to the connection strength between two genes. This value is between 0 and 1, and the higher value refers to a stronger connection or co-expression of genes.<br><br></p></div>";
        doc.innerHTML= tab;
        });
}
function loadconet2(ntfile){
        //var ntfile = getCookie('networkcsv');
        //alert(ntfile);
        if (ntfile == ""){
                var doc = document.getElementById("rescotable");
                doc.innerHTML= "File: ntfile<br>No data to display";
        }else{
                var gene = ntfile.split('/')[1].split("\.")[0];
                //efile = "data/top19edges/"+gene+".csv";
                //plotcoex(efile,gene);
		$("#rescotabletitle").html("Co-expression neighborhood: "+gene+" (top 20)");
                loadcotable(ntfile);
        }
}


</script>
</html>
